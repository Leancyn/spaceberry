<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Spaceberry</title>
    <link rel="icon" href="assets/img/favicon.png" type="image/png" />
    <link rel="stylesheet" href="assets/css/style.css" />
    <link rel="stylesheet" href="assets/css/settings.css" />

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  </head>

  <body class="settings-page">
    <div class="container">
      <!-- SIDEBAR START -->
      <aside class="sidebar">
        <img src="assets/img/logo (2).png" alt="Spaceberry" />
        <nav>
          <a href="#" class="nav-item active"
            ><i data-feather="home"></i><span>Dashboard</span></a
          >
          <a href="assets/page/dictionary.html" class="nav-item"
            ><i data-feather="book-open"></i><span>Dictionary</span></a
          >
          <a href="assets/page/schedule.html" class="nav-item"
            ><i data-feather="calendar"></i><span>Schedule</span></a
          >
          <a href="assets/page/settings.html" class="nav-item"
            ><i data-feather="settings"></i><span>Settings</span></a
          >
        </nav>
        <div class="contact-box">
          <i data-feather="mail" class="contact-icon"></i>
          <p class="contact-text">Need help or have questions?</p>
          <a href="https://wa.me/6289503711530"
            ><button class="contact-btn">Contact Us</button></a
          >
        </div>
      </aside>
      <!-- SIDEBAR END -->

      <main class="main-content">
        <header class="header">
          <input
            type="text"
            id="searchInput"
            class="search-index"
            placeholder="Search..."
          />

          <div class="header-avatar" id="headerAvatarContainer">
            <img
              id="headerAvatar"
              src="assets/img/user-profile.png"
              alt="User"
            />
            <div class="user-dropdown" id="userDropdown">
              <p id="dropdownNameMobile">Annie Leonchart</p>
              <p id="dropdownEmailMobile">annie_leonchart@mail.com</p>
              <div class="user-stats-mobile">
                <div><strong id="mobileLessons">0</strong><br />Lessons</div>
                <div><strong id="mobileTerms">0</strong><br />Terms</div>
              </div>
              <button id="logoutBtnMobile">Logout</button>
            </div>
          </div>
        </header>

        <div class="dashboard-grid">
          <div class="left-column">
            <!-- CARD START -->
            <section class="word-sets">
              <h3>Word Sets</h3>
              <div class="cards">
                <div
                  class="card"
                  data-link="assets/page/booksAndLibrary/main.html"
                >
                  <img
                    src="assets/img/books.png"
                    alt="Books"
                    class="card-icon"
                  />
                  <div class="card-title">Books and Library</div>
                </div>
                <div class="card" data-link="assets/page/exercise.html">
                  <img
                    src="assets/img/brain.png"
                    alt="Books"
                    class="card-icon"
                  />
                  <div class="card-title">Interactive Exercises</div>
                </div>
                <div class="card" data-link="assets/page/qotd.html">
                  <img
                    src="assets/img/quote.png"
                    alt="Books"
                    class="card-icon"
                  />
                  <div class="card-title">Quote of the Day</div>
                </div>
                <div class="card world-clock-card">
                  <div class="card-title">What is o'clock now?</div>
                  <div class="digital-clock" id="digitalClock">00:00:00</div>
                  <div class="clock-date" id="clockDate">Loading date...</div>
                </div>
              </div>
            </section>
            <!-- CARD END -->

            <!-- STATISTIK START -->
            <section class="statistics">
              <h3>Statistics</h3>
              <div id="realtimeChart" class="chart-placeholder"></div>
            </section>
            <!-- STATISTIK END -->
          </div>

          <div class="right-column">
            <!-- USER PROFILE START -->
            <section class="user-profile-card">
              <div class="user-profile full-profile" id="userProfileCard">
                <div class="profile-container">
                  <img
                    id="dropdownPhoto"
                    src="assets/img/user-profile.png"
                    alt="User"
                    class="avatar-profile"
                  />
                  <div class="profile-info">
                    <h3 id="dropdownName">Annie Leonchart</h3>
                    <p id="dropdownEmail">annie_leonchart@mail.com</p>
                    <div class="user-stats">
                      <div>
                        <strong id="userLessons">0</strong><br />Lessons
                      </div>
                      <div><strong id="userTerms">0</strong><br />Terms</div>
                    </div>
                    <button id="logoutBtn">Logout</button>
                  </div>
                </div>
              </div>
            </section>
            <!-- USER PROFILE END -->

            <!-- QUICK START -->
            <section class="quick-start">
              <h3>Quick Start</h3>
              <div class="quick-cards">
                <div
                  class="quick-card"
                  data-link="assets/page/quickCards/exam.html"
                >
                  <img
                    src="assets/img/exam.png"
                    alt="Books"
                    class="quick-card-icon"
                  />
                  <div class="quick-card-title">Exam - 20 min</div>
                </div>
                <div
                  class="quick-card"
                  data-link="assets/page/quickCards/writing.html"
                >
                  <img
                    src="assets/img/writing.png"
                    alt="Books"
                    class="quick-card-icon"
                  />
                  <div class="quick-card-title">Writing - 20 min</div>
                </div>
                <div
                  class="quick-card"
                  data-link="assets/page/quickCards/grammar.html"
                >
                  <img
                    src="assets/img/grammar.png"
                    alt="Books"
                    class="quick-card-icon"
                  />
                  <div class="quick-card-title">Grammar - 20 min</div>
                </div>
              </div>
            </section>
            <!-- QUICK START -->
          </div>
        </div>
      </main>
    </div>

    <div class="contact-query">
      <a href="https://wa.me/6289503711530"
        ><i data-feather="help-circle"></i
      ></a>
    </div>

    <script src="assets/js/feather.min.js"></script>
    <script src="assets/js/script.js"></script>
    <script src="assets/js/apexcharts.min.js"></script>
    <script src="assets/js/chart-script.js"></script>
    <script src="assets/js/settings.js"></script>

    <script>
      feather.replace();

      const firebaseConfig = {
        apiKey: "AIzaSyBDIYWlSgxpjdpHAs6xKFJGaTvM86EKe-4",
        authDomain: "spaceberry-bf68b.firebaseapp.com",
        projectId: "spaceberry-bf68b",
        storageBucket: "spaceberry-bf68b.firebasestorage.app",
        messagingSenderId: "185481236967",
        appId: "1:185481236967:web:222422307c4218517fed42",
        measurementId: "G-2E7GZY8NNE",
      };

      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();

      document.addEventListener("DOMContentLoaded", () => {
        const avatar = document.getElementById("dropdownPhoto");
        const logoutBtn = document.getElementById("logoutBtn");
        const headerAvatar = document.getElementById("headerAvatar");
        const userDropdown = document.getElementById("userDropdown");
        const logoutBtnMobile = document.getElementById("logoutBtnMobile");

        // Toggle dropdown saat avatar mobile diklik
        if (headerAvatar && userDropdown) {
          headerAvatar.addEventListener("click", () => {
            userDropdown.style.display =
              userDropdown.style.display === "block" ? "none" : "block";
          });

          window.addEventListener("click", (e) => {
            if (
              !e.target.closest("#headerAvatar") &&
              !e.target.closest("#userDropdown")
            ) {
              userDropdown.style.display = "none";
            }
          });
        }

        // Logout versi mobile
        if (logoutBtnMobile) {
          logoutBtnMobile.addEventListener("click", () => {
            auth.signOut().then(() => {
              location.href = "assets/page/login.html";
            });
          });
        }

        // Logout versi desktop
        if (logoutBtn) {
          logoutBtn.addEventListener("click", () => {
            auth.signOut().then(() => {
              location.href = "assets/page/login.html";
            });
          });
        }

        // Autentikasi dan ambil data pengguna
        auth.onAuthStateChanged((user) => {
          if (!user) {
            location.href = "assets/page/login.html";
            return;
          }

          const photo = user.photoURL || "assets/img/user-profile.png";
          const name = user.displayName || "Anonymous";
          const email = user.email || "-";

          const customAvatar = localStorage.getItem("customAvatar");

          const avatar = document.getElementById("headerAvatar");
          const dropdownPhoto = document.getElementById("dropdownPhoto");

          if (avatar) avatar.src = customAvatar || photo;
          if (dropdownPhoto) dropdownPhoto.src = customAvatar || photo;

          const nameDesktop = document.getElementById("dropdownName");
          const emailDesktop = document.getElementById("dropdownEmail");
          if (nameDesktop) nameDesktop.textContent = name;
          if (emailDesktop) emailDesktop.textContent = email;

          const nameMobile = document.getElementById("dropdownNameMobile");
          const emailMobile = document.getElementById("dropdownEmailMobile");
          if (nameMobile) nameMobile.textContent = name;
          if (emailMobile) emailMobile.textContent = email;

          // Ambil statistik pengguna
          db.collection("users")
            .doc(user.uid)
            .get()
            .then((doc) => {
              if (doc.exists) {
                const data = doc.data();
                const lessons = data.lessons ?? 0;
                const terms = data.terms ?? 0;

                const lessonsEl = document.getElementById("userLessons");
                const termsEl = document.getElementById("userTerms");
                if (lessonsEl) lessonsEl.textContent = lessons;
                if (termsEl) termsEl.textContent = terms;

                // Mobile
                const mobileLessons = document.getElementById("mobileLessons");
                const mobileTerms = document.getElementById("mobileTerms");
                if (mobileLessons) mobileLessons.textContent = lessons;
                if (mobileTerms) mobileTerms.textContent = terms;
              } else {
                console.warn("Dokumen pengguna tidak ditemukan.");
              }
            })
            .catch((err) => {
              console.error("Gagal ambil data statistik:", err);
            });
        });

        firebase.auth.onAuthStateChanged(async (user) => {
          if (!user) return;

          try {
            // Ambil avatar dari Firestore
            const doc = await db.collection("users").doc(user.uid).get();
            const firestoreAvatar = doc.exists ? doc.data().photo : null;

            // Prioritaskan avatar Firestore, fallback ke default
            const avatarUrl =
              firestoreAvatar || "/spaceberry/assets/img/user-profile.png";

            // Tampilkan ke semua tempat
            const avatarEls = [
              document.getElementById("headerAvatar"),
              document.getElementById("dropdownPhoto"),
            ];

            avatarEls.forEach((el) => {
              if (el) el.src = avatarUrl;
            });
          } catch (err) {
            console.error("Gagal memuat avatar pengguna:", err);
          }
        });
      });
    </script>
  </body>
</html>
